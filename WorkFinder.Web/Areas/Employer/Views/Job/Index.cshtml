@model IEnumerable<WorkFinder.Web.Models.Job>
@using WorkFinder.Web.Extensions
@{
    ViewData["Title"] = "My Jobs";
    Layout = "_EmployerLayout";
}

<div class="container">
    <div class="employers-dashboard mt-4">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header mb-4">
                <h5>EMPLOYERS DASHBOARD</h5>
            </div>
            <ul class="sidebar-menu">
                <li>
                    <a href="@Url.Action("Index", "Home", new { area = "Employer" })" class="d-flex align-items-center">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        <span>Overview</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="d-flex align-items-center">
                        <i class="fas fa-building me-2"></i>
                        <span>Employers Profile</span>
                    </a>
                </li>
                <li>
                    <a href="@Url.Action("Create", "Job", new { area = "Employer" })" class="d-flex align-items-center">
                        <i class="fas fa-plus-circle me-2"></i>
                        <span>Post a Job</span>
                    </a>
                </li>
                <li class="active">
                    <a href="@Url.Action("Index", "Job", new { area = "Employer" })" class="d-flex align-items-center">
                        <i class="fas fa-briefcase me-2"></i>
                        <span>My Jobs</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="d-flex align-items-center">
                        <i class="fas fa-user me-2"></i>
                        <span>Saved Candidate</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="d-flex align-items-center">
                        <i class="fas fa-credit-card me-2"></i>
                        <span>Plans & Billing</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="d-flex align-items-center">
                        <i class="fas fa-building me-2"></i>
                        <span>All Companies</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="d-flex align-items-center">
                        <i class="fas fa-cog me-2"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
            <div class="sidebar-footer mt-4">
                <a href="@Url.Action("Logout", "Auth", new { area = "Auth" })" class="d-flex align-items-center">
                    <i class="fas fa-sign-out-alt me-2"></i> Log-out
                </a>
            </div>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            @await Html.PartialAsync("../Shared/_JobsListPartial", Model)
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the job "<span id="jobTitleToDelete"></span>"?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteJobForm" asp-action="Delete" asp-controller="Job" asp-area="Employer" method="post">
                    <input type="hidden" id="jobIdToDelete" name="id" />
                    <button type="submit" class="btn btn-danger">Delete Job</button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .employers-dashboard {
        display: flex;
        gap: 30px;
    }

    /* Sidebar */
    .sidebar {
        width: 250px;
        flex-shrink: 0;
        font-size: 1.6rem;
    }

    .sidebar-header h5 {
        font-size: 14px;
        font-weight: 600;
        color: #777;
        margin-bottom: 20px;
    }

    .sidebar-menu {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .sidebar-menu li {
        margin-bottom: 15px;
    }

    .sidebar-menu li a {
        display: flex;
        align-items: center;
        color: #666;
        text-decoration: none;
        padding: 8px 15px;
        border-radius: 6px;
        transition: all 0.3s;
    }

    .sidebar-menu li a:hover,
    .sidebar-menu li.active a {
        background-color: rgba(0, 123, 255, 0.1);
        color: #0d6efd;
    }

    .sidebar-menu li.active a {
        font-weight: 500;
    }

    .sidebar-menu li a i {
        width: 20px;
        text-align: center;
        margin-right: 8px;
    }

    .sidebar-footer {
        padding-top: 15px;
        border-top: 1px solid #eee;
    }

    .sidebar-footer a {
        color: #666;
        text-decoration: none;
        font-size: 14px;
    }

    .sidebar-footer a:hover {
        color: #0d6efd;
    }

    /* Main Content */
    .main-content {
        flex: 1;
    }

    /* Table Styles */
    .table {
        font-size: 14px;
    }

    .table th {
        font-weight: 600;
        color: #555;
    }

    .job-title a {
        color: #0d6efd;
        font-weight: 500;
        text-decoration: none;
    }

    .job-title a:hover {
        text-decoration: underline;
    }

    .btn-group .btn {
        padding: 0.25rem 0.5rem;
    }

    /* Responsive */
    @@media(max - width: 992px) {
            .employers-dashboard {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                margin-bottom: 30px;
            }
        }
    </style>

    @section Scripts {
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                // Hiển thị toast message khi có tham số toastMessage từ controller
                const urlParams = new URLSearchParams(window.location.search);
                const toastMessage = urlParams.get('toastMessage');
                if (toastMessage && window.toast) {
                    window.toast.showToast('Success', toastMessage, 'success');

                    // Xóa tham số toastMessage khỏi URL để tránh hiển thị lại khi refresh
                    const cleanUrl = window.location.pathname +
                        (urlParams.toString() ? '?' + urlParams.toString().replace(/toastMessage=[^&]*(&|$)/, '') : '');
                    window.history.replaceState({}, document.title, cleanUrl.replace(/\?$/, ''));
                }

                // Load jobs data via AJAX for dynamic updating
                async function loadJobsData(page = 1, pageSize = 10) {
                    try {
                        const response = await fetch(`/Employer/Job/GetJobs?page=${page}&pageSize=${pageSize}`, {
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Accept': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const contentType = response.headers.get("content-type");
                        if (!contentType || !contentType.includes("application/json")) {
                            throw new TypeError("Response was not JSON");
                        }

                        const result = await response.json();

                        if (result && result.success) {
                            // Reload the page to apply the changes
                            window.location.href = window.location.pathname + '?page=' + page;
                        } else {
                            if (window.toast) {
                                window.toast.showToast('Error', result?.message || 'Failed to load jobs', 'error');
                            } else {
                                alert(result?.message || 'Failed to load jobs');
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load jobs data:', error);
                        if (window.toast) {
                            window.toast.showToast('Error', 'Failed to load jobs data. Please try again.', 'error');
                        } else {
                            alert('Failed to load jobs data. Please try again.');
                        }
                    }
                }

                // Add click handlers to pagination links
                const paginationLinks = document.querySelectorAll('#jobs-pagination .page-link');
                paginationLinks.forEach(link => {
                    link.addEventListener('click', function (e) {
                        if (!this.getAttribute('href').startsWith('javascript:')) {
                            e.preventDefault();
                            const page = parseInt(this.getAttribute('data-page'));
                            if (!isNaN(page)) {
                                loadJobsData(page);
                            }
                        }
                    });
                });
            });
        </script>
    }